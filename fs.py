#! /usr/bin/env python3

import xml.etree.ElementTree as ET

NUM_PARTIES = 3

# https://elections.sos.state.tx.us/elchist331_race832.htm
ELECTION_DATA = {
    "ANDERSON": (11335, 3307, 94, 14736, 28487),
    "ANDREWS": (3338, 776, 17, 4131, 9574),
    "ANGELINA": (19166, 7130, 153, 26449, 51751),
    "ARANSAS": (6677, 2247, 56, 8980, 17308),
    "ARCHER": (3208, 376, 18, 3602, 6317),
    "ARMSTRONG": (819, 74, 6, 899, 1428),
    "ATASCOSA": (7753, 4332, 119, 12204, 27338),
    "AUSTIN": (8722, 2241, 84, 11047, 19406),
    "BAILEY": (1204, 405, 7, 1616, 3727),
    "BANDERA": (7643, 1865, 76, 9584, 15869),
    "BASTROP": (15067, 12082, 312, 27461, 47438),
    "BAYLOR": (1070, 156, 9, 1235, 2365),
    "BEE": (4342, 2811, 64, 7217, 15883),
    "BELL": (47437, 38417, 723, 86577, 195760),
    "BEXAR": (217600, 326946, 5024, 549570, 1098257),
    "BLANCO": (4181, 1570, 57, 5808, 8504),
    "BORDEN": (320, 22, 1, 343, 488),
    "BOSQUE": (5718, 1374, 63, 7155, 12209),
    "BOWIE": (20157, 7982, 182, 28321, 59618),
    "BRAZORIA": (65693, 45228, 832, 111753, 207446),
    "BRAZOS": (35971, 27876, 640, 64487, 114377),
    "BREWSTER": (1879, 2147, 60, 4086, 7292),
    "BRISCOE": (553, 69, 2, 624, 1084),
    "BROOKS": (543, 1376, 4, 1923, 5843),
    "BROWN": (10391, 1670, 71, 12132, 23368),
    "BURLESON": (5079, 1427, 45, 6551, 11782),
    "BURNET": (13859, 4444, 187, 18490, 31072),
    "CALDWELL": (6147, 5227, 107, 11481, 23777),
    "CALHOUN": (4198, 1874, 47, 6119, 12835),
    "CALLAHAN": (4373, 610, 40, 5023, 9337),
    "CAMERON": (28574, 48770, 568, 77912, 206966),
    "CAMP": (2749, 1119, 24, 3892, 7648),
    "CARSON": (2192, 245, 22, 2459, 4263),
    "CASS": (8148, 2024, 45, 10217, 20119),
    "CASTRO": (1219, 394, 10, 1623, 3842),
    "CHAMBERS": (12146, 2926, 109, 15181, 28063),
    "CHEROKEE": (11631, 3207, 103, 14941, 27949),
    "CHILDRESS": (1526, 236, 8, 1770, 3559),
    "CLAY": (3710, 547, 31, 4288, 7655),
    "COCHRAN": (541, 140, 5, 686, 1729),
    "COKE": (1150, 137, 10, 1297, 2285),
    "COLEMAN": (2759, 351, 16, 3126, 5912),
    "COLLIN": (187425, 165614, 2927, 355966, 579893),
    "COLLINGSWORTH": (810, 113, 5, 928, 1906),
    "COLORADO": (5779, 1825, 33, 7637, 13938),
    "COMAL": (44079, 16830, 586, 61495, 100867),
    "COMANCHE": (3799, 781, 30, 4610, 9197),
    "CONCHO": (803, 163, 14, 980, 1677),
    "COOKE": (11879, 2550, 111, 14540, 25747),
    "CORYELL": (10626, 5067, 170, 15863, 38635),
    "COTTLE": (458, 97, 2, 557, 1063),
    "CRANE": (836, 213, 6, 1055, 2666),
    "CROCKETT": (928, 340, 8, 1276, 2497),
    "CROSBY": (978, 437, 7, 1422, 3540),
    "CULBERSON": (297, 521, 9, 827, 1722),
    "DALLAM": (970, 139, 6, 1115, 3039),
    "DALLAS": (241126, 481395, 5368, 727889, 1335313),
    "DAWSON": (2192, 811, 12, 3015, 7202),
    "DEAF SMITH": (2680, 1067, 28, 3775, 8855),
    "DELTA": (1562, 354, 16, 1932, 3896),
    "DENTON": (158744, 134649, 2409, 295802, 497490),
    "DE WITT": (4974, 1128, 29, 6131, 11744),
    "DICKENS": (635, 113, 6, 754, 1288),
    "DIMMIT": (840, 2042, 12, 2894, 7378),
    "DONLEY": (1110, 161, 8, 1279, 2237),
    "DUVAL": (1330, 2765, 18, 4113, 8377),
    "EASTLAND": (5377, 800, 28, 6205, 11775),
    "ECTOR": (20996, 9230, 248, 30474, 76536),
    "EDWARDS": (604, 145, 8, 757, 1449),
    "ELLIS": (41022, 19106, 461, 60589, 108349),
    "EL PASO": (50943, 151482, 1189, 203614, 455992),
    "ERATH": (10055, 2486, 84, 12625, 22492),
    "FALLS": (3215, 1445, 20, 4680, 10399),
    "FANNIN": (8569, 2107, 74, 10750, 20756),
    "FAYETTE": (8228, 2198, 53, 10479, 16626),
    "FISHER": (1139, 340, 15, 1494, 2682),
    "FLOYD": (1394, 476, 9, 1879, 3965),
    "FOARD": (321, 113, 1, 435, 913),
    "FORT BEND": (111423, 142399, 1616, 255438, 431832),
    "FRANKLIN": (3300, 639, 35, 3974, 6807),
    "FREESTONE": (5243, 1279, 40, 6562, 11978),
    "FRIO": (1636, 2016, 28, 3680, 8606),
    "GAINES": (3317, 513, 19, 3849, 8921),
    "GALVESTON": (67641, 45065, 916, 113622, 212630),
    "GARZA": (1068, 203, 16, 1287, 2712),
    "GILLESPIE": (9890, 2572, 81, 12543, 19294),
    "GLASSCOCK": (513, 37, 4, 554, 782),
    "GOLIAD": (2326, 717, 29, 3072, 5597),
    "GONZALES": (4173, 1421, 31, 5625, 12210),
    "GRAY": (5246, 615, 40, 5901, 12493),
    "GRAYSON": (31655, 11157, 332, 43144, 80863),
    "GREGG": (24569, 11133, 234, 35936, 69893),
    "GRIMES": (6499, 2037, 71, 8607, 16176),
    "GUADALUPE": (33938, 20079, 554, 54571, 100552),
    "HALE": (5360, 1970, 62, 7392, 19170),
    "HALL": (807, 161, 3, 971, 1987),
    "HAMILTON": (2795, 507, 28, 3330, 5611),
    "HANSFORD": (1552, 138, 20, 1710, 3034),
    "HARDEMAN": (973, 185, 4, 1162, 2459),
    "HARDIN": (17391, 2636, 71, 20098, 38259),
    "HARRIS": (498902, 700200, 8652, 1207754, 2338460),
    "HARRISON": (16226, 6245, 122, 22593, 44462),
    "HARTLEY": (1467, 153, 4, 1624, 2875),
    "HASKELL": (1362, 302, 10, 1674, 3331),
    "HAYS": (33308, 45584, 854, 79746, 134403),
    "HEMPHILL": (1209, 157, 9, 1375, 2289),
    "HENDERSON": (20891, 5415, 205, 26511, 51770),
    "HIDALGO": (46505, 104416, 834, 151755, 361562),
    "HILL": (8927, 2443, 63, 11433, 22743),
    "HOCKLEY": (4844, 1211, 39, 6094, 13582),
    "HOOD": (20090, 4720, 195, 25005, 40835),
    "HOPKINS": (9306, 2545, 69, 11920, 22706),
    "HOUSTON": (5552, 1772, 36, 7360, 13090),
    "HOWARD": (5651, 1693, 60, 7404, 16968),
    "HUDSPETH": (509, 407, 17, 933, 1922),
    "HUNT": (21115, 7151, 222, 28488, 55193),
    "HUTCHINSON": (5854, 753, 35, 6642, 13547),
    "IRION": (636, 96, 6, 738, 1314),
    "JACK": (2498, 296, 19, 2813, 5082),
    "JACKSON": (3991, 832, 17, 4840, 9195),
    "JASPER": (9504, 2282, 47, 11833, 22848),
    "JEFF DAVIS": (683, 466, 28, 1177, 1719),
    "JEFFERSON": (36731, 37128, 380, 74239, 148344),
    "JIM HOGG": (410, 1060, 8, 1478, 3833),
    "JIM WELLS": (4520, 5331, 49, 9900, 26438),
    "JOHNSON": (39571, 12411, 454, 52436, 97157),
    "JONES": (4115, 832, 37, 4984, 10024),
    "KARNES": (2900, 1203, 33, 4136, 8071),
    "KAUFMAN": (26118, 12002, 252, 38372, 72579),
    "KENDALL": (15292, 4340, 164, 19796, 30774),
    "KENEDY": (100, 77, 3, 180, 309),
    "KENT": (288, 44, 5, 337, 588),
    "KERR": (16822, 5198, 185, 22205, 35854),
    "KIMBLE": (1495, 195, 14, 1704, 2908),
    "KING": (124, 6, 1, 131, 184),
    "KINNEY": (827, 358, 14, 1199, 2255),
    "KLEBERG": (4081, 4456, 59, 8596, 18186),
    "KNOX": (855, 229, 9, 1093, 2434),
    "LAMAR": (12711, 3731, 126, 16568, 31591),
    "LAMB": (2741, 699, 17, 3457, 8096),
    "LAMPASAS": (5836, 1569, 65, 7470, 14099),
    "LA SALLE": (673, 813, 3, 1489, 4300),
    "LAVACA": (6688, 1019, 30, 7737, 13234),
    "LEE": (4487, 1322, 38, 5847, 10453),
    "LEON": (5711, 855, 23, 6589, 11163),
    "LIBERTY": (16041, 4421, 114, 20576, 43981),
    "LIMESTONE": (5211, 1672, 33, 6916, 13621),
    "LIPSCOMB": (942, 116, 9, 1067, 1988),
    "LIVE OAK": (3029, 601, 21, 3651, 7240),
    "LLANO": (7954, 2124, 76, 10154, 15758),
    "LOVING": (47, 6, 1, 54, 121),
    "LUBBOCK": (58780, 32068, 731, 91579, 175881),
    "LYNN": (1369, 323, 5, 1697, 3945),
    "MADISON": (3033, 780, 18, 3831, 7428),
    "MARION": (2448, 1018, 31, 3497, 7368),
    "MARTIN": (1297, 243, 14, 1554, 3252),
    "MASON": (1560, 402, 5, 1967, 2956),
    "MATAGORDA": (7330, 3049, 78, 10457, 21654),
    "MAVERICK": (2951, 7727, 98, 10776, 31453),
    "MCCULLOCH": (2245, 400, 26, 2671, 5243),
    "MCLENNAN": (45855, 28452, 568, 74875, 139699),
    "MCMULLEN": (387, 41, 2, 430, 704),
    "MEDINA": (11444, 4621, 114, 16179, 31354),
    "MENARD": (632, 145, 6, 783, 1443),
    "MIDLAND": (32867, 9723, 365, 42955, 84393),
    "MILAM": (5922, 1997, 68, 7987, 15038),
    "MILLS": (1764, 229, 11, 2004, 3426),
    "MITCHELL": (1585, 323, 5, 1913, 4562),
    "MONTAGUE": (6424, 941, 56, 7421, 13588),
    "MONTGOMERY": (137395, 51268, 1433, 190096, 333488),
    "MOORE": (3248, 787, 25, 4060, 9764),
    "MORRIS": (2953, 1260, 21, 4234, 8302),
    "MOTLEY": (483, 40, 4, 527, 847),
    "NACOGDOCHES": (13775, 7732, 126, 21633, 36993),
    "NAVARRO": (10391, 3918, 107, 14416, 28641),
    "NEWTON": (3660, 993, 23, 4676, 9293),
    "NOLAN": (3120, 928, 26, 4074, 8778),
    "NUECES": (45956, 47392, 719, 94067, 205176),
    "OCHILTREE": (2160, 230, 25, 2415, 5216),
    "OLDHAM": (732, 82, 2, 816, 1417),
    "ORANGE": (21164, 5050, 118, 26332, 53392),
    "PALO PINTO": (7547, 1837, 46, 9430, 17984),
    "PANOLA": (7120, 1598, 31, 8749, 16392),
    "PARKER": (44071, 9956, 468, 54495, 91858),
    "PARMER": (1675, 372, 10, 2057, 4428),
    "PECOS": (2161, 1339, 20, 3520, 8223),
    "POLK": (12794, 3850, 106, 16750, 38018),
    "POTTER": (16689, 7521, 214, 24424, 55580),
    "PRESIDIO": (436, 1221, 10, 1667, 4884),
    "RAINS": (3702, 681, 23, 4406, 7668),
    "RANDALL": (38479, 9613, 363, 48455, 87827),
    "REAGAN": (692, 136, 6, 834, 1845),
    "REAL": (1311, 245, 8, 1564, 2590),
    "RED RIVER": (3427, 973, 18, 4418, 8268),
    "REEVES": (1128, 1255, 15, 2398, 7089),
    "REFUGIO": (1636, 847, 9, 2492, 4949),
    "ROBERTS": (441, 19, 0, 460, 707),
    "ROBERTSON": (4295, 1942, 31, 6268, 11654),
    "ROCKWALL": (26615, 11754, 330, 38699, 62933),
    "RUNNELS": (2842, 385, 7, 3234, 6692),
    "RUSK": (12597, 3609, 76, 16282, 31242),
    "SABINE": (3456, 496, 15, 3967, 7802),
    "SAN AUGUSTINE": (2266, 734, 16, 3016, 5989),
    "SAN JACINTO": (7499, 1785, 55, 9339, 17976),
    "SAN PATRICIO": (11335, 6777, 107, 18219, 41762),
    "SAN SABA": (1811, 247, 11, 2069, 3737),
    "SCHLEICHER": (735, 209, 8, 952, 1789),
    "SCURRY": (3705, 642, 16, 4363, 9393),
    "SHACKELFORD": (1174, 103, 4, 1281, 2320),
    "SHELBY": (6008, 1521, 32, 7561, 15294),
    "SHERMAN": (692, 87, 43, 822, 1535),
    "SMITH": (53760, 23182, 458, 77400, 134712),
    "SOMERVELL": (3033, 633, 25, 3691, 6287),
    "STARR": (2443, 8273, 68, 10784, 33110),
    "STEPHENS": (2631, 324, 13, 2968, 5573),
    "STERLING": (442, 44, 0, 486, 880),
    "STONEWALL": (497, 112, 5, 614, 957),
    "SUTTON": (934, 265, 7, 1206, 2478),
    "SWISHER": (1461, 420, 14, 1895, 3968),
    "TARRANT": (309189, 313497, 5208, 627894, 1122597),
    "TAYLOR": (29811, 10489, 357, 40657, 80168),
    "TERRELL": (323, 139, 5, 467, 694),
    "TERRY": (2169, 629, 15, 2813, 6633),
    "THROCKMORTON": (617, 77, 9, 703, 1219),
    "TITUS": (5685, 2265, 55, 8005, 17020),
    "TOM GREEN": (24648, 9690, 292, 34630, 66826),
    "TRAVIS": (119278, 359772, 5154, 484204, 775950),
    "TRINITY": (4146, 998, 31, 5175, 11455),
    "TYLER": (5919, 1185, 35, 7139, 13725),
    "UPSHUR": (11529, 2364, 91, 13984, 27708),
    "UPTON": (854, 169, 8, 1031, 2116),
    "UVALDE": (4348, 3528, 59, 7935, 17118),
    "VAL VERDE": (5345, 5955, 105, 11405, 27972),
    "VAN ZANDT": (15182, 2634, 116, 17932, 36982),
    "VICTORIA": (19005, 8046, 157, 27208, 55473),
    "WALKER": (11535, 6186, 132, 17853, 33422),
    "WALLER": (10167, 6335, 101, 16603, 32584),
    "WARD": (2096, 800, 24, 2920, 6522),
    "WASHINGTON": (10134, 3263, 95, 13492, 23253),
    "WEBB": (13814, 35159, 408, 49381, 130784),
    "WHARTON": (9094, 3793, 55, 12942, 25132),
    "WHEELER": (1679, 125, 6, 1810, 3415),
    "WICHITA": (23648, 9971, 299, 33918, 81419),
    "WILBARGER": (2639, 776, 24, 3439, 8134),
    "WILLACY": (1527, 2773, 25, 4325, 12405),
    "WILLIAMSON": (99857, 105850, 2514, 208221, 331985),
    "WILSON": (13025, 4567, 127, 17719, 32537),
    "WINKLER": (1123, 321, 11, 1455, 3870),
    "WISE": (19023, 3915, 179, 23117, 41749),
    "WOOD": (13987, 2635, 118, 16740, 30065),
    "YOAKUM": (1558, 335, 10, 1903, 4264),
    "YOUNG": (5543, 821, 41, 6405, 11854),
    "ZAPATA": (821, 1392, 10, 2223, 7587),
    "ZAVALA": (589, 2313, 15, 2917, 8157),
}


class Polygon:
    def __init__(self, name, points):
        self.name = name
        self.points = points
        self.neighbors = set()

        data = ELECTION_DATA[name.upper()]
        self.votes = list(data[:NUM_PARTIES])
        total_votes, self.num_voters = data[NUM_PARTIES:]
        assert sum(self.votes) == total_votes
        assert self.num_voters > total_votes

        self.winner = self.votes.index(max(*self.votes))

    def __str__(self):
        return self.name

    __repr__ = __str__

    @staticmethod
    def Key(poly):
        return poly.name


def LoadPolys():
    tree = ET.parse("Texas_County_Boundaries_Detailed.kml")
    root = tree.getroot()
    polys = []
    for place in root.findall(".//{http://www.opengis.net/kml/2.2}Placemark"):
        name = place.find(
            ".//{http://www.opengis.net/kml/2.2}SimpleData[@name='CNTY_NM']"
        ).text
        coords = place.find(".//{http://www.opengis.net/kml/2.2}coordinates").text
        poly = Polygon(
            name, [tuple(map(float, xy.split(","))) for xy in coords.split(" ")]
        )
        polys.append(poly)
    polys.sort(key=Polygon.Key)
    return polys


def FindNeighbors(polys):
    point_index = {}
    for poly in polys:
        for point in poly.points:
            point_index.setdefault(point, []).append(poly)
    adjacency = {}
    for polys_for_point in point_index.values():
        if len(polys_for_point) > 1:
            for p1 in polys_for_point:
                for p2 in polys_for_point:
                    if p1 is not p2:
                        p1.neighbors.add(p2)


class Main:
    def __init__(self):
        polys = LoadPolys()
        FindNeighbors(polys)
        # for p in polys:
        #     print(p, sorted(p.neighbors, key=Polygon.Key))
        winners_by_party = [0] * NUM_PARTIES
        votes_by_party = [0] * NUM_PARTIES
        for p in polys:
            winners_by_party[p.winner] += 1
            for i in range(NUM_PARTIES):
                votes_by_party[i] += p.votes[i]
        print([winners_by_party[i] / votes_by_party[i] for i in range(NUM_PARTIES)])


Main()
